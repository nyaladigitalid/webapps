<!DOCTYPE html>
<html class="dark" lang="id">
<head>
<script>(function(){try{var t=localStorage.getItem("theme");if(t==="light"){document.documentElement.classList.remove("dark");}else{document.documentElement.classList.add("dark");}}catch(e){document.documentElement.classList.add("dark");}})();</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Nyala Digital Apps - Konfigurasi Meta Ads</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
tailwind.config = {
    darkMode: "class",
    theme: {
        extend: {
            colors: {
                primary: "#ef7225",
                secondary: "#0d3b66",
                "background-light": "#f5f7f8",
                "background-dark": "#0b0e14",
                "sidebar-dark": "#101922"
            },
            fontFamily: {
                display: ["Inter", "sans-serif"]
            },
            borderRadius: {
                DEFAULT: "0.5rem",
                lg: "0.5rem",
                xl: "0.75rem",
                full: "9999px"
            }
        }
    }
};
</script>
<style>
body {
    font-family: "Inter", sans-serif;
}
.glass-surface {
    background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.14), transparent 60%), radial-gradient(circle at bottom right, rgba(29, 155, 240, 0.18), transparent 60%);
}
.glass-panel {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(15, 23, 42, 0.1);
    backdrop-filter: blur(22px);
    -webkit-backdrop-filter: blur(22px);
}
.dark .glass-panel {
    background: rgba(6, 12, 31, 0.94);
    border: 1px solid rgba(148, 163, 184, 0.35);
}
</style>
</head>
<body class="bg-background-light text-slate-900 dark:bg-background-dark dark:text-white min-h-screen glass-surface" data-active="meta_config">
<div class="hidden dark:block fixed inset-0 pointer-events-none opacity-30">
<div class="absolute inset-0 bg-[radial-gradient(#0f172a_1px,transparent_1px)] [background-size:40px_40px]"></div>
</div>
<div class="relative z-10 min-h-screen flex flex-col">
<div id="include-header"></div>
<div class="flex-1 max-w-7xl mx-auto w-full px-6 py-6 flex gap-5">
<!-- Sidebar -->
<div id="include-sidebar"></div>
<!-- Main Content -->
<main class="flex-1 flex flex-col min-w-0 overflow-hidden">
<div class="flex-1 overflow-y-auto space-y-6">
<!-- Page Title Area -->
<div class="px-4 md:px-0 flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
        <h1 class="text-xl md:text-2xl font-semibold tracking-tight">Konfigurasi Meta Ads</h1>
        <p class="text-secondary/80 text-sm mt-1">Atur koneksi API Meta Ads untuk manajemen kampanye otomatis.</p>
    </div>
</div>

<!-- Tabs Navigation -->
<div class="border-b border-slate-200 dark:border-white/10 mx-4 md:mx-0">
    <nav class="-mb-px flex gap-6" aria-label="Tabs">
        <button onclick="switchTab('ad-accounts')" id="tab-ad-accounts" class="border-primary text-primary whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
            Ad Accounts
        </button>
        <button onclick="switchTab('fanspages')" id="tab-fanspages" class="border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
            Fanspages
        </button>
    </nav>
</div>

<!-- Configuration Form -->
<div class="glass-panel rounded-2xl p-6 md:p-8 mx-4 md:mx-0 border border-slate-200 dark:border-white/10 w-full">
    <form id="meta-config-form" class="space-y-6">
        
        <!-- Tab Content: Ad Accounts -->
        <div id="content-ad-accounts" class="space-y-4">
            <div class="space-y-2">
                <label for="access_token" class="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Access Token (System User)</label>
                <div class="relative">
                    <input type="password" id="access_token" name="access_token" placeholder="EAA..." 
                           class="w-full bg-slate-50 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all pr-10">
                    <button type="button" onclick="toggleVisibility('access_token')" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-lg">visibility</span>
                    </button>
                </div>
                <p class="text-[10px] text-slate-400">Token akses jangka panjang dengan permission ads_management.</p>
            </div>

            <div class="flex items-center justify-between">
                <label class="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Ad Accounts</label>
                <button type="button" onclick="addAdAccount()" class="text-primary hover:text-primary/80 text-sm font-bold flex items-center gap-1">
                    <span class="material-symbols-outlined">add</span> Tambah Akun Iklan
                </button>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-white/10">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 dark:bg-white/5 text-xs uppercase font-bold text-slate-500 dark:text-slate-400">
                        <tr>
                            <th class="px-4 py-3">Nama Akun</th>
                            <th class="px-4 py-3">Account ID (act_)</th>
                            <th class="px-4 py-3 w-32 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="ad-accounts-container" class="divide-y divide-slate-200 dark:divide-white/10">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>
            
            <div class="space-y-2 pt-4 border-t border-slate-100 dark:border-white/5">
                <label for="pixel_id" class="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Pixel ID (Opsional)</label>
                <input type="text" id="pixel_id" name="pixel_id" placeholder="Ex: 9876543210" 
                       class="w-full bg-slate-50 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all">
            </div>
        </div>

        <!-- Tab Content: Fanspages -->
        <div id="content-fanspages" class="space-y-4 hidden -mt-4">
            <div class="flex items-center justify-between">
                <label class="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">Fanspages List</label>
                <button type="button" onclick="addNewFanspage()" class="text-primary hover:text-primary/80 text-sm font-bold flex items-center gap-1">
                    <span class="material-symbols-outlined">add</span> Tambah Fanspage
                </button>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-white/10">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 dark:bg-white/5 text-xs uppercase font-bold text-slate-500 dark:text-slate-400">
                        <tr>
                            <th class="px-4 py-3">Fanspage ID</th>
                            <th class="px-4 py-3">Fanspage Name</th>
                            <th class="px-4 py-3 w-40 text-center">Account ID</th>
                            <th class="px-4 py-3 w-16 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="fanspages-container" class="divide-y divide-slate-200 dark:divide-white/10">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="flex items-center justify-between px-2">
                <div class="text-xs text-slate-500 dark:text-slate-400">
                    Showing <span id="page-start" class="font-medium text-slate-900 dark:text-white">0</span> to <span id="page-end" class="font-medium text-slate-900 dark:text-white">0</span> of <span id="total-items" class="font-medium text-slate-900 dark:text-white">0</span> results
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="changePage(-1)" id="btn-prev" class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10 text-slate-500 dark:text-slate-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <span class="material-symbols-outlined text-lg">chevron_left</span>
                    </button>
                    <div id="page-numbers" class="flex items-center gap-1">
                        <!-- Dynamic Page Numbers -->
                    </div>
                    <button type="button" onclick="changePage(1)" id="btn-next" class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10 text-slate-500 dark:text-slate-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <span class="material-symbols-outlined text-lg">chevron_right</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="pt-4 border-t border-slate-100 dark:border-white/5 flex items-center justify-between">
            <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 transition-all flex items-center gap-2 ml-auto">
                <span class="material-symbols-outlined">save</span>
                Simpan Konfigurasi
            </button>
        </div>
    </form>
</div>

</div>
</main>
</div>
<div id="include-footer"></div>
</div>
<script src="js/include.js"></script>
<script>
function switchTab(tabName) {
        // Update Tab Styles
        document.querySelectorAll('[id^="tab-"]').forEach(el => {
            el.classList.remove('border-primary', 'text-primary');
            el.classList.add('border-transparent', 'text-slate-500', 'dark:text-slate-400');
        });
        const activeTab = document.getElementById(`tab-${tabName}`);
        activeTab.classList.remove('border-transparent', 'text-slate-500', 'dark:text-slate-400');
        activeTab.classList.add('border-primary', 'text-primary');

        // Toggle Content
        document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`content-${tabName}`).classList.remove('hidden');
    }

    function addAdAccount(name = '', id = '') {
        const container = document.getElementById('ad-accounts-container');
        const tr = document.createElement('tr');
        tr.className = "group hover:bg-slate-50 dark:hover:bg-white/5 transition-colors";
        
        tr.innerHTML = `
            <td class="px-4 py-2">
                <input type="text" name="account_names[]" value="${name}" placeholder="Ex: Nyala Utama" 
                       class="w-full bg-transparent border-0 border-b border-transparent focus:border-primary focus:ring-0 text-sm px-0 py-1 transition-colors">
            </td>
            <td class="px-4 py-2">
                <input type="text" name="account_ids[]" value="${id}" placeholder="1234567890" 
                       class="w-full bg-transparent border-0 border-b border-transparent focus:border-primary focus:ring-0 text-sm px-0 py-1 transition-colors font-mono">
            </td>
            <td class="px-4 py-2 text-center">
                <div class="flex items-center justify-center gap-1">
                    <button type="button" onclick="testConnection(this)" class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10 text-slate-500 dark:text-slate-400 hover:text-primary transition-colors" title="Test Koneksi">
                        <span class="material-symbols-outlined text-lg">sync_alt</span>
                    </button>
                    <button type="button" onclick="this.closest('tr').remove()" class="p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-slate-400 hover:text-red-500 transition-colors" title="Hapus">
                        <span class="material-symbols-outlined text-lg">delete</span>
                    </button>
                </div>
            </td>
        `;
        container.appendChild(tr);
    }

    let currentPage = 1;
    const itemsPerPage = 10;

    function updatePagination() {
        const rows = document.querySelectorAll('#fanspages-container tr');
        const totalItems = rows.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        // Ensure current page is valid
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
        if (totalItems === 0) currentPage = 1;
        
        // Show/Hide Rows
        rows.forEach((row, index) => {
            if (index >= (currentPage - 1) * itemsPerPage && index < currentPage * itemsPerPage) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update Info Text
        const start = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, totalItems);
        document.getElementById('page-start').textContent = start;
        document.getElementById('page-end').textContent = end;
        document.getElementById('total-items').textContent = totalItems;
        
        // Update Buttons
        document.getElementById('btn-prev').disabled = currentPage <= 1;
        document.getElementById('btn-next').disabled = currentPage >= totalPages || totalPages === 0;
        
        // Render Page Numbers
        const pageNumbersContainer = document.getElementById('page-numbers');
        pageNumbersContainer.innerHTML = '';
        
        // Simple pagination: just show all pages if few, or limit if many (but here max is ~3 pages)
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `w-7 h-7 rounded-md text-xs font-medium transition-colors ${
                i === currentPage 
                ? 'bg-primary text-white shadow-sm' 
                : 'hover:bg-slate-100 dark:hover:bg-white/10 text-slate-500 dark:text-slate-400'
            }`;
            btn.textContent = i;
            btn.onclick = () => {
                currentPage = i;
                updatePagination();
            };
            pageNumbersContainer.appendChild(btn);
        }
    }

    function changePage(delta) {
        currentPage += delta;
        updatePagination();
    }

    function addNewFanspage() {
        addFanspage();
        // Go to last page to see the new item
        const rows = document.querySelectorAll('#fanspages-container tr');
        const totalPages = Math.ceil(rows.length / itemsPerPage);
        currentPage = totalPages;
        updatePagination();
    }

    function addFanspage(name = '', id = '', accountId = '') {
        const container = document.getElementById('fanspages-container');
        const tr = document.createElement('tr');
        tr.className = "group hover:bg-slate-50 dark:hover:bg-white/5 transition-colors";
        
        tr.innerHTML = `
            <td class="px-4 py-2">
                <input type="text" name="fanspage_ids[]" value="${id}" placeholder="1234567890" 
                       class="w-full bg-transparent border-0 border-b border-transparent focus:border-primary focus:ring-0 text-sm px-0 py-1 transition-colors font-mono">
            </td>
            <td class="px-4 py-2">
                <input type="text" name="fanspage_names[]" value="${name}" placeholder="Ex: Promo UMKM" 
                       class="w-full bg-transparent border-0 border-b border-transparent focus:border-primary focus:ring-0 text-sm px-0 py-1 transition-colors">
            </td>
            <td class="px-4 py-2 text-center">
                <input type="text" name="fanspage_account_ids[]" value="${accountId}" placeholder="R10" 
                       class="w-full bg-transparent border-0 border-b border-transparent focus:border-primary focus:ring-0 text-sm px-0 py-1 transition-colors text-center uppercase">
            </td>
            <td class="px-4 py-2 text-center">
                <button type="button" onclick="this.closest('tr').remove(); updatePagination();" class="text-slate-400 hover:text-red-500 transition-colors p-1 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20" title="Hapus">
                    <span class="material-symbols-outlined text-lg">delete</span>
                </button>
            </td>
        `;
        container.appendChild(tr);
    }

    function testConnection(btn) {
        const row = btn.closest('tr');
        const idInput = row.querySelector('input[name="account_ids[]"]');
        const id = idInput.value;
        
        if (!id) {
            alert('Masukkan ID Akun terlebih dahulu');
            return;
        }

        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-lg">refresh</span>';
        btn.disabled = true;

        // Mock connection test
        setTimeout(() => {
            btn.innerHTML = '<span class="material-symbols-outlined text-green-600 text-lg">check_circle</span>';
            btn.classList.add('bg-green-100', 'dark:bg-green-900/30');
            
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                btn.classList.remove('bg-green-100', 'dark:bg-green-900/30');
            }, 3000);
        }, 1000);
    }

    document.addEventListener("DOMContentLoaded", async function() {
        // Load existing config from API
        try {
            const response = await fetch('/api/meta-config');
            const config = await response.json();
            
            if (config) {
                document.getElementById('access_token').value = config.access_token || '';
                document.getElementById('pixel_id').value = config.pixel_id || '';
                
                // Load accounts
                const container = document.getElementById('ad-accounts-container');
                container.innerHTML = ''; // Clear default
                if (config.accounts && Array.isArray(config.accounts) && config.accounts.length > 0) {
                    config.accounts.forEach(acc => addAdAccount(acc.name, acc.id));
                } else {
                    addAdAccount(); // Default empty row
                }

                // Load fanspages
                const fpContainer = document.getElementById('fanspages-container');
                fpContainer.innerHTML = ''; // Clear default
                 if (config.fanspages && Array.isArray(config.fanspages) && config.fanspages.length > 0) {
                     config.fanspages.forEach(fp => addFanspage(fp.name, fp.id, fp.accountId));
                 } else {
                     // Default empty row if no data
                     // Note: We are not using the hardcoded default list anymore as we migrated to MySQL
                     // User should add them manually or we can provide a "Seed" button later if needed.
                     addFanspage(); 
                 }
                 updatePagination();
            }
        } catch (e) {
            console.error("Error loading config:", e);
            // Fallback to empty rows
            addAdAccount();
            addFanspage();
        }
    });

    document.getElementById('meta-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            access_token: formData.get('access_token'),
            pixel_id: formData.get('pixel_id'),
            accounts: [],
            fanspages: []
        };
        
        // Parse Accounts
        const accNames = formData.getAll('account_names[]');
        const accIds = formData.getAll('account_ids[]');
        accNames.forEach((name, i) => {
            if (name && accIds[i]) {
                data.accounts.push({ name, id: accIds[i] });
            }
        });
        
        // Parse Fanspages
        const fpNames = formData.getAll('fanspage_names[]');
        const fpIds = formData.getAll('fanspage_ids[]');
        const fpAccIds = formData.getAll('fanspage_account_ids[]');
        
        fpNames.forEach((name, i) => {
            if (name && fpIds[i]) {
                data.fanspages.push({ name, id: fpIds[i], accountId: fpAccIds[i] });
            }
        });
        
        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Saving...';
            btn.disabled = true;

            const res = await fetch('/api/meta-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (result.success) {
                // Show success
                 btn.innerHTML = '<span class="material-symbols-outlined">check</span> Saved!';
                 btn.classList.add('bg-green-600', 'hover:bg-green-700');
                 setTimeout(() => {
                     btn.innerHTML = originalText;
                     btn.disabled = false;
                     btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                 }, 2000);
            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (e) {
            alert('Error saving: ' + e.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
</script>
</body>
</html>