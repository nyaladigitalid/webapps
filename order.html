<!DOCTYPE html>

<html class="dark" lang="id"><head>
<script>(function(){try{var t=localStorage.getItem("theme");if(t==="light"){document.documentElement.classList.remove("dark");}else{document.documentElement.classList.add("dark");}}catch(e){document.documentElement.classList.add("dark");}})();</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Nyala Digital Apps - Pesanan</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
tailwind.config = {
    darkMode: "class",
    theme: {
        extend: {
            colors: {
                primary: "#ef7225",
                secondary: "#0d3b66",
                "background-light": "#f5f7f8",
                "background-dark": "#0b0e14",
                "sidebar-dark": "#101922"
            },
            fontFamily: {
                display: ["Inter", "sans-serif"]
            },
            borderRadius: {
                DEFAULT: "0.5rem",
                lg: "0.5rem",
                xl: "0.75rem",
                full: "9999px"
            }
        }
    }
};
</script>
<style>
body {
    font-family: "Inter", sans-serif;
}
.glass-surface {
    background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.14), transparent 60%), radial-gradient(circle at bottom right, rgba(29, 155, 240, 0.18), transparent 60%);
}
.glass-panel {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(15, 23, 42, 0.1);
    backdrop-filter: blur(22px);
    -webkit-backdrop-filter: blur(22px);
}
.metric-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.92));
    border: 1px solid rgba(15, 23, 42, 0.08);
}
.pill {
    background: linear-gradient(135deg, rgba(29, 155, 240, 0.08), rgba(249, 115, 22, 0.08));
}
.dark .glass-panel {
    background: rgba(6, 12, 31, 0.94);
    border: 1px solid rgba(148, 163, 184, 0.35);
}
.dark .metric-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.92));
    border: 1px solid rgba(255,255,255,0.1);
}
.dark .pill {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.18), rgba(29, 155, 240, 0.22));
}
</style>
</head>
<body class="bg-background-light text-slate-900 dark:bg-background-dark dark:text-white min-h-screen glass-surface" data-active="orders">
<div class="hidden dark:block fixed inset-0 pointer-events-none opacity-30">
<div class="absolute inset-0 bg-[radial-gradient(#0f172a_1px,transparent_1px)] [background-size:40px_40px]"></div>
</div>
<div class="relative z-10 min-h-screen flex flex-col">
<div id="include-header"></div>
<div class="flex-1 max-w-7xl mx-auto w-full px-6 py-6 flex gap-5">
<!-- Sidebar -->
<div id="include-sidebar"></div>
<!-- Main Content -->
<main class="flex-1 flex flex-col min-w-0 overflow-hidden">
<div class="flex-1 overflow-y-auto space-y-6">
<!-- Page Title Area -->
<div class="px-4 md:px-0 flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
        <h1 class="text-xl md:text-2xl font-semibold tracking-tight">Pesanan</h1>
        <p class="text-secondary/80 text-sm mt-1">Kelola dan pantau seluruh pesanan klien Anda.</p>
    </div>
    <button id="btn-input-baru" style="display: none;" class="inline-flex items-center gap-2 bg-primary hover:bg-primary/90 text-white px-5 py-2.5 rounded-lg font-bold text-sm transition-all shadow-lg shadow-primary/20">
        <span class="material-symbols-outlined text-lg">add</span>
        Input Baru
    </button>
</div>
<!-- Filters & Stats -->
<div class="px-4 md:px-0 flex flex-col md:flex-row gap-4 justify-between items-center">
    <!-- Filters Group -->
    <div class="flex flex-wrap items-center gap-2 w-full md:w-auto" id="filters-container">
        <!-- Status Filter -->
        <div class="relative">
            <select id="status-filter" class="appearance-none bg-secondary/10 border border-secondary/20 text-secondary dark:text-white text-xs font-medium rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:ring-1 focus:ring-primary/50 cursor-pointer hover:bg-secondary/20 transition-colors">
                <option value="all">Semua Status</option>
                <option value="active">Aktif</option>
                <option value="pending">Pending</option>
                <option value="completed">Selesai</option>
            </select>
            <span class="absolute right-2 top-1/2 -translate-y-1/2 material-symbols-outlined text-secondary/60 dark:text-white/60 text-[16px] pointer-events-none">expand_more</span>
        </div>

        <!-- Month Filter -->
        <div class="relative">
            <select id="month-filter" class="appearance-none bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-600 dark:text-white text-xs font-medium rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:ring-1 focus:ring-primary/50 cursor-pointer hover:bg-slate-50 dark:hover:bg-white/10 transition-colors">
                <option value="all">Semua Bulan</option>
                <option value="1">Januari</option>
                <option value="2">Februari</option>
                <option value="3">Maret</option>
                <option value="4">April</option>
                <option value="5">Mei</option>
                <option value="6">Juni</option>
                <option value="7">Juli</option>
                <option value="8">Agustus</option>
                <option value="9">September</option>
                <option value="10">Oktober</option>
                <option value="11">November</option>
                <option value="12">Desember</option>
            </select>
            <span class="absolute right-2 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 dark:text-white/40 text-[16px] pointer-events-none">expand_more</span>
        </div>

        <!-- Year Filter -->
        <div class="relative">
            <select id="year-filter" class="appearance-none bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-600 dark:text-white text-xs font-medium rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:ring-1 focus:ring-primary/50 cursor-pointer hover:bg-slate-50 dark:hover:bg-white/10 transition-colors">
                <option value="all">Semua Tahun</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
            </select>
            <span class="absolute right-2 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 dark:text-white/40 text-[16px] pointer-events-none">expand_more</span>
        </div>
    </div>

    <!-- Search & Date Custom -->
    <div class="flex flex-wrap items-center gap-3 w-full md:w-auto justify-end">
        <div class="flex items-center gap-2" title="Rentang Tanggal Custom">
            <input type="date" id="date-start" class="bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg px-2 py-1.5 text-xs text-slate-700 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all w-28">
            <span class="text-slate-400">-</span>
            <input type="date" id="date-end" class="bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg px-2 py-1.5 text-xs text-slate-700 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all w-28">
        </div>
        <div class="relative group w-full md:w-48">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 dark:text-white/40 text-[18px]">search</span>
            <input type="text" id="search-input" placeholder="Cari..." 
                   class="w-full bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-full pl-9 pr-4 py-1.5 text-xs text-slate-700 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all placeholder:text-slate-400 dark:placeholder:text-white/30">
        </div>
    </div>
</div>
<!-- Table Card -->
<div class="glass-panel rounded-2xl overflow-hidden mx-4 md:mx-0 border border-slate-200 dark:border-white/10">
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="border-b border-slate-100 dark:border-white/5 bg-slate-50 dark:bg-white/5">
<th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider w-16 text-center">#</th>
<th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">Tanggal</th>
<th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">Nama Klien</th>
<th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">Durasi</th>
              <th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">Start Date</th>
              <th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">End Date</th>
              <th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">Status</th>
<th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">No WhatsApp</th>
<th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider">Sisa</th>
<th class="px-6 py-4 text-[11px] font-black text-slate-500 dark:text-[#90aecb] uppercase tracking-wider w-10"></th>
</tr>
</thead>
<tbody id="orders-tbody" class="divide-y divide-slate-100 dark:divide-white/5">
    <!-- Data will be populated by JS -->
</tbody>
</table>
</div>
<!-- Pagination Footer -->
<div class="px-6 py-4 flex items-center justify-between bg-slate-50 dark:bg-white/5 border-t border-slate-100 dark:border-white/10">
<p id="pagination-info" class="text-[11px] text-slate-500 dark:text-secondary/80">Menampilkan <span class="text-slate-900 dark:text-white font-medium">0 - 0</span> dari <span class="text-slate-900 dark:text-white font-medium">0</span> pesanan</p>
<div id="pagination-controls" class="flex items-center gap-2">
    <!-- Generated by JS -->
</div>
</div>
</div>
<!-- Simple Cards for Mobile View (Alternative) -->
<div id="orders-mobile-container" class="px-4 md:px-0 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:hidden">
    <!-- Data will be populated by JS -->
</div>
</div>
<!-- New Order Modal -->
<div id="new-order-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeOrderModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="glass-panel w-full max-w-4xl max-h-[90vh] rounded-2xl flex flex-col overflow-hidden relative pointer-events-auto shadow-2xl transform transition-all scale-100">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-white/10 bg-slate-50/50 dark:bg-white/5">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">add_circle</span>
                    Buat Pesanan Baru
                </h2>
                <button onclick="closeOrderModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                <!-- Smart Order Section -->
                <div class="bg-slate-50 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl overflow-hidden mb-6">
                    <div class="px-4 py-3 bg-slate-100 dark:bg-white/5 border-b border-slate-200 dark:border-white/10 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-sm">auto_fix_high</span>
                            <span class="text-xs font-bold text-slate-700 dark:text-white uppercase tracking-wide">Mode Smart Order</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-smart-order" class="sr-only peer">
                            <div class="w-9 h-5 bg-slate-300 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div id="smart-order-panel" class="hidden p-4 space-y-4 transition-all">
                        <p class="text-xs text-slate-500 dark:text-slate-400">Tempelkan teks pesanan (dari WhatsApp/Email) untuk mengisi formulir secara otomatis.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <textarea id="smart-src-text" class="w-full h-32 bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg p-3 text-xs font-mono focus:ring-1 focus:ring-primary placeholder:text-slate-400" placeholder="Paste text here..."></textarea>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Target Layanan</label>
                                    <select id="smart-service-type" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-primary">
                                        <option value="ads">Ads Service</option>
                                        <option value="creative">Creative Studio</option>
                                        <option value="development">Software Dev</option>
                                        <option value="training">Training</option>
                                        <option value="prodigi">Product Digital</option>
                                    </select>
                                </div>
                                <button id="btn-smart-parse" class="w-full py-2 bg-primary text-white text-xs font-bold rounded-lg shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined text-sm">auto_fix_high</span>
                                    Parsing & Isi Form
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Client -->
                <section class="space-y-4">
                    <h3 class="text-sm font-bold text-primary uppercase tracking-wider flex items-center gap-2">
                        <span class="flex items-center justify-center size-6 rounded-full bg-primary text-white text-xs font-bold">1</span>
                        Informasi Klien
                    </h3>

                    <!-- Client Search / Selection -->
                    <div class="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/10 transition-all focus-within:ring-1 focus-within:ring-primary/50">
                        <div class="flex gap-4 mb-4">
                            <div class="flex-1 relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">search</span>
                                <input type="text" id="client-search" placeholder="Cari nama, bisnis, atau WA..." 
                                       class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg pl-10 pr-4 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary placeholder:text-slate-400">
                                <!-- Dropdown results -->
                                <div id="client-results" class="hidden absolute top-full left-0 right-0 mt-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-lg shadow-xl z-20 max-h-60 overflow-y-auto divide-y divide-slate-100 dark:divide-white/5"></div>
                            </div>
                            <button id="btn-new-client" class="px-4 py-2 bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 text-slate-700 dark:text-white text-sm font-medium rounded-lg transition-colors whitespace-nowrap">
                                + Klien Baru
                            </button>
                        </div>

                        <!-- Selected Client Form -->
                        <div id="client-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="client-id">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Nama Klien</label>
                                <input type="text" id="client-name" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Nama Bisnis</label>
                                <input type="text" id="client-business" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">WhatsApp</label>
                                <input type="text" id="client-wa" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Alamat</label>
                                <input type="text" id="client-address" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Step 1.5: Assignment (Super Admin Only) -->
                <section id="step-assignment" class="space-y-4 hidden">
                    <h3 class="text-sm font-bold text-primary uppercase tracking-wider flex items-center gap-2">
                        <span class="flex items-center justify-center size-6 rounded-full bg-primary text-white text-xs font-bold">!</span>
                        Assignment (Super Admin)
                    </h3>
                    <div class="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/10">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-2">Pilih CS</label>
                        <select id="assignment-cs" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="">Pilih CS...</option>
                        </select>
                    </div>
                </section>

                <!-- Step 2: Product & Service -->
                <section class="space-y-4 opacity-50 pointer-events-none transition-all duration-300" id="step-2">
                    <h3 class="text-sm font-bold text-primary uppercase tracking-wider flex items-center gap-2">
                        <span class="flex items-center justify-center size-6 rounded-full bg-primary text-white text-xs font-bold">2</span>
                        Layanan & Produk
                    </h3>

                    <div class="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/10 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Service Type -->
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-2">Jenis Layanan</label>
                            <div class="grid grid-cols-2 gap-2" id="service-type-options">
                                <label class="cursor-pointer">
                                    <input type="radio" name="service_type" value="ads" class="peer sr-only" checked>
                                    <div class="p-2 rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 text-slate-600 dark:text-slate-300 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary transition-all text-center text-sm font-medium hover:bg-slate-50 dark:hover:bg-white/10">
                                        Ads Service
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="service_type" value="creative" class="peer sr-only">
                                    <div class="p-2 rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 text-slate-600 dark:text-slate-300 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary transition-all text-center text-sm font-medium hover:bg-slate-50 dark:hover:bg-white/10">
                                        Creative Studio
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="service_type" value="development" class="peer sr-only">
                                    <div class="p-2 rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 text-slate-600 dark:text-slate-300 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary transition-all text-center text-sm font-medium hover:bg-slate-50 dark:hover:bg-white/10">
                                        Software Dev
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="service_type" value="training" class="peer sr-only">
                                    <div class="p-2 rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 text-slate-600 dark:text-slate-300 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary transition-all text-center text-sm font-medium hover:bg-slate-50 dark:hover:bg-white/10">
                                        Training
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="service_type" value="prodigi" class="peer sr-only">
                                    <div class="p-2 rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 text-slate-600 dark:text-slate-300 peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary transition-all text-center text-sm font-medium hover:bg-slate-50 dark:hover:bg-white/10">
                                        Product Digital
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Package Selection -->
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-2">Pilih Paket</label>
                            <select id="package-select" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="">Pilih Paket...</option>
                            </select>
                            <div id="package-info" class="mt-2 text-xs text-slate-500 dark:text-slate-400 hidden bg-slate-100 dark:bg-white/5 p-2 rounded border border-slate-200 dark:border-white/5">
                                <div class="flex justify-between">
                                    <span>Harga: <span class="text-slate-900 dark:text-white font-bold" id="pkg-price">-</span></span>
                                    <span>Durasi: <span class="text-slate-900 dark:text-white" id="pkg-duration">-</span></span>
                                </div>
                                <p class="mt-1 text-slate-600 dark:text-slate-300 italic" id="pkg-desc"></p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Step 3: Details -->
                <section class="space-y-4 opacity-50 pointer-events-none transition-all duration-300" id="step-3">
                    <h3 class="text-sm font-bold text-primary uppercase tracking-wider flex items-center gap-2">
                        <span class="flex items-center justify-center size-6 rounded-full bg-primary text-white text-xs font-bold">3</span>
                        Detail Pesanan
                    </h3>

                    <div class="space-y-4">
                        <!-- Dynamic Service Fields -->
                        <div class="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/10">
                            <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">tune</span>
                                Spesifikasi Layanan
                            </h4>
                            <div id="dynamic-fields" class="space-y-4">
                                <!-- Dynamic fields injected here based on Service Type -->
                            </div>
                        </div>

                        <!-- General Brief Fields -->
                        <div id="common-brief-section" class="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/10 hidden">
                            <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">description</span>
                                Brief & Target
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Deskripsi Produk/Jasa</label>
                                    <textarea id="brief-desc" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" rows="2" placeholder="Jelaskan detail produk atau jasa..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Keunggulan (Advantages)</label>
                                    <textarea id="brief-adv" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" rows="2" placeholder="Apa kelebihan produk ini?"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Keunikan (Uniqueness)</label>
                                    <textarea id="brief-unique" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" rows="2" placeholder="Apa yang membedakan dengan kompetitor?"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Promo / Offer</label>
                                    <input type="text" id="brief-promo" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="Diskon 50%, Beli 1 Gratis 1, dll">
                                </div>
                                <div class="border-t border-slate-200 dark:border-white/10 md:col-span-2 my-2"></div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Target Lokasi</label>
                                    <input type="text" id="target-loc" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="Indonesia, Jakarta, Surabaya...">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Target Usia</label>
                                        <input type="text" id="target-age" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="18-35">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Gender</label>
                                        <select id="target-gender" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                                            <option value="All">Semua</option>
                                            <option value="Male">Laki-laki</option>
                                            <option value="Female">Perempuan</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-slate-200 dark:border-white/10 flex justify-end gap-3 bg-slate-50 dark:bg-black/20">
                <button onclick="closeOrderModal()" class="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-white/5 text-sm font-medium transition-colors">Batal</button>
                <button id="btn-save-order" class="px-6 py-2 bg-primary hover:bg-primary/90 text-white text-sm font-bold rounded-lg shadow-lg shadow-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">save</span>
                    Simpan Pesanan
                </button>
            </div>
        </div>
    </div>
</div>
<div id="include-footer"></div>
</main>
</div>
<script src="js/include.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  var cleanupModalHandlers = null;
  var openBtn = document.getElementById("btn-input-baru");
  var modalRoot = document.getElementById("smartorder-root");
  function closeModal() {
    document.body.classList.remove("overflow-hidden");
    if (typeof cleanupModalHandlers === "function") {
      try { cleanupModalHandlers(); } catch (_) {}
      cleanupModalHandlers = null;
    }
    if (modalRoot) {
      modalRoot.classList.add("hidden");
      modalRoot.innerHTML = "";
    }
  }
  function renderOrders(rows){
    var tbody = document.getElementById("orders-tbody");
    var mobileContainer = document.getElementById("orders-mobile-container");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (mobileContainer) mobileContainer.innerHTML = "";

    rows.forEach(function(r){
      var statusBadge = '';
      var s = String(r.status || '').toLowerCase();
      var statusClassMobile = "bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-white/70 border border-slate-200 dark:border-white/20"; 

      if (s === 'active') {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight bg-green-500/10 text-green-600 border border-green-500/20 dark:bg-green-500/20 dark:text-green-400 dark:border-green-500/30"><span class="size-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-ping"></span>Active</span>';
        statusClassMobile = "bg-green-500/10 text-green-600 border border-green-500/20 dark:bg-green-500/20 dark:text-green-400 dark:border-green-500/30";
      } else if (s === 'pending' || s === 'draft') {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight bg-yellow-500/10 text-yellow-600 border border-yellow-500/20 dark:bg-yellow-500/20 dark:text-yellow-400 dark:border-yellow-500/30"><span class="size-1.5 rounded-full bg-yellow-500 dark:bg-yellow-400"></span>Pending</span>';
        statusClassMobile = "bg-yellow-500/10 text-yellow-600 border border-yellow-500/20 dark:bg-yellow-500/20 dark:text-yellow-400 dark:border-yellow-500/30";
      } else if (s === 'baru' || s === 'new') {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight bg-blue-500/10 text-blue-600 border border-blue-500/20 dark:bg-blue-500/20 dark:text-blue-400 dark:border-blue-500/30"><span class="size-1.5 rounded-full bg-blue-500 dark:bg-blue-400"></span>Baru</span>';
        statusClassMobile = "bg-blue-500/10 text-blue-600 border border-blue-500/20 dark:bg-blue-500/20 dark:text-blue-400 dark:border-blue-500/30";
      } else if (s === 'perpanjang' || s === 'extend' || s === 'repeat') {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight bg-purple-500/10 text-purple-600 border border-purple-500/20 dark:bg-purple-500/20 dark:text-purple-400 dark:border-purple-500/30"><span class="size-1.5 rounded-full bg-purple-500 dark:bg-purple-400"></span>Perpanjang</span>';
        statusClassMobile = "bg-purple-500/10 text-purple-600 border border-purple-500/20 dark:bg-purple-500/20 dark:text-purple-400 dark:border-purple-500/30";
      } else if (s === 'completed' || s === 'done') {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight border bg-primary/10 text-primary border-primary/20 dark:bg-primary/20 dark:text-primary dark:border-primary/30"><span class="size-1.5 rounded-full bg-primary"></span>Completed</span>';
        statusClassMobile = "bg-primary/10 text-primary border border-primary/20 dark:bg-primary/20 dark:text-primary dark:border-primary/30";
      } else if (s === 'proses konten') {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight bg-indigo-500/10 text-indigo-600 border border-indigo-500/20 dark:bg-indigo-500/20 dark:text-indigo-400 dark:border-indigo-500/30"><span class="size-1.5 rounded-full bg-indigo-500 dark:bg-indigo-400 animate-pulse"></span>Proses Konten</span>';
        statusClassMobile = "bg-indigo-500/10 text-indigo-600 border border-indigo-500/20 dark:bg-indigo-500/20 dark:text-indigo-400 dark:border-indigo-500/30";
      } else if (s === 'siap iklan') {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight bg-cyan-500/10 text-cyan-600 border border-cyan-500/20 dark:bg-cyan-500/20 dark:text-cyan-400 dark:border-cyan-500/30"><span class="size-1.5 rounded-full bg-cyan-500 dark:bg-cyan-400"></span>Siap Iklan</span>';
        statusClassMobile = "bg-cyan-500/10 text-cyan-600 border border-cyan-500/20 dark:bg-cyan-500/20 dark:text-cyan-400 dark:border-cyan-500/30";
      } else {
        statusBadge = '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-tight bg-slate-100 text-slate-500 border border-slate-200 dark:bg-white/10 dark:text-white/70 dark:border-white/20">Unknown</span>';
      }
      var prog = (r.progress_percent == null)
        ? (function(s){
            s = String(s||'').toLowerCase();
            if (s === 'completed' || s === 'done') return 100;
            if (s === 'active') return 70;
            if (s === 'siap iklan') return 60;
            if (s === 'proses konten') return 40;
            if (s === 'pending' || s === 'draft') return 15;
            if (s === 'baru' || s === 'new') return 10;
            return 0;
          })(r.status)
        : Number(r.progress_percent || 0);
      var days = r.days_remaining == null ? '' : String(r.days_remaining) + ' Hari';
      var repeatIcon = r.repeat_order ? '<span class="material-symbols-outlined text-primary text-[16px]" title="Repeat Order">sync</span>' : '';
      var pkg = r.packageName || '-';
      var createdDate = r.created_at ? new Date(r.created_at).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : '-';
      var clientWa = r.clientWhatsapp || '-';
      var tr = document.createElement('tr');
      tr.className = "hover:bg-slate-50 dark:hover:bg-white/5 transition-colors group cursor-pointer border-b border-slate-100 dark:border-white/5 last:border-0";
      tr.innerHTML = ''
        + '<td class="px-6 py-4 text-sm font-medium text-slate-500 dark:text-[#90aecb] text-center">'+ r.id +'</td>'
        + '<td class="px-6 py-4 text-sm text-slate-500 dark:text-[#90aecb] whitespace-nowrap">'+ createdDate +'</td>'
        + '<td class="px-6 py-4">'
        + '<div class="flex flex-col">'
        + '<div class="flex items-center gap-2">'
        + '<span class="text-sm font-semibold text-slate-900 dark:text-white">' + (r.clientName || '(Tanpa Nama)') + '</span>' 
        + '<span class="text-[10px] font-medium bg-slate-100 border border-slate-200 text-slate-600 px-1.5 py-0.5 rounded dark:bg-white/5 dark:border-white/10 dark:text-white/90 whitespace-nowrap">' + pkg + '</span>'
        + repeatIcon 
        + '</div>'
        + (r.businessName ? '<div class="text-[11px] text-slate-500 dark:text-slate-400 mt-1">' + r.businessName + '</div>' : '')
        + '</div>'
        + '</td>'
        + '<td class="px-6 py-4 text-sm text-slate-600 dark:text-white/80">' + (r.duration ? r.duration + ' Hari' : '-') + '</td>'
        + '<td class="px-6 py-4 text-sm text-slate-600 dark:text-white/80">' + ((r.metaData && r.metaData.ads_start_date) ? r.metaData.ads_start_date : '-') + '</td>'
        + '<td class="px-6 py-4 text-sm text-slate-600 dark:text-white/80">' + ((r.metaData && r.metaData.ads_end_date) ? r.metaData.ads_end_date : '-') + '</td>'
        + '<td class="px-6 py-4">' + statusBadge + '</td>'
        + '<td class="px-6 py-4"><div class="flex items-center gap-2 text-slate-600 dark:text-white/80"><span class="material-symbols-outlined text-[16px] text-green-500">chat</span><span class="text-sm font-medium">'
        + clientWa + '</span></div></td>'
        + '<td class="px-6 py-4"><span class="text-xs font-bold text-slate-600 dark:text-white/80">'
        + (days || '-') + '</span></td>'
        + '<td class="px-6 py-4 text-right"><button class="text-slate-400 hover:text-slate-600 dark:text-[#90aecb] dark:hover:text-white transition-colors"><span class="material-symbols-outlined text-xl">more_vert</span></button></td>';
      tr.addEventListener('click', function(e){
        var t = e.target;
        if (t && (t.closest && t.closest('button'))) return;
        window.location.href = 'orderdetail.html?id=' + encodeURIComponent(r.id);
      });
      tbody.appendChild(tr);

      // Mobile Card
      if (mobileContainer) {
          var card = document.createElement("div");
          card.className = "glass-panel rounded-2xl p-5 space-y-4 cursor-pointer hover:shadow-lg transition-shadow border border-slate-200 dark:border-white/10";
          card.innerHTML = ''
            + '<div class="flex justify-between items-start">'
            + '<div>'
            + '<p class="text-[10px] text-slate-500 dark:text-[#90aecb] font-black uppercase tracking-widest">ORDER #' + r.id + '</p>'
            + '<div class="flex items-center gap-2 mt-1">'
            + '<h3 class="text-lg font-bold text-slate-900 dark:text-white">' + (r.clientName || '(Tanpa Nama)') + '</h3>'
            + (r.repeat_order ? '<span class="material-symbols-outlined text-primary text-[16px] animate-pulse">sync</span>' : '')
            + '</div>'
            + (r.businessName ? '<p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">' + r.businessName + '</p>' : '')
            + '</div>'
            + '<span class="' + statusClassMobile + ' text-[10px] font-black px-2 py-1 rounded uppercase">' + (r.status || 'Unknown') + '</span>'
            + '</div>'
            + '<div class="space-y-1">'
            + '<div class="flex justify-between text-xs font-medium">'
            + '<span class="text-slate-500 dark:text-[#90aecb]">Progress Kampanye</span>'
            + '<span class="text-slate-900 dark:text-white">' + Math.min(Math.max(prog,0),100) + '%</span>'
            + '</div>'
            + '<div class="w-full bg-slate-200 dark:bg-white/10 h-2 rounded-full overflow-hidden">'
            + '<div class="bg-primary h-full rounded-full" style="width: ' + Math.min(Math.max(prog,0),100) + '%"></div>'
            + '</div>'
            + '</div>'
            + '<div class="flex justify-between items-center pt-2 border-t border-slate-100 dark:border-white/5">'
            + '<span class="text-xs text-slate-500 dark:text-[#90aecb]">Sisa: <span class="text-orange-500 dark:text-orange-400 font-bold italic">' + (days || '-') + '</span></span>'
            + '<button class="text-xs font-bold text-primary hover:text-primary/80 transition-colors">Detail</button>'
            + '</div>';
          
          card.addEventListener('click', function(e){
            var t = e.target;
            if (t && (t.closest && t.closest('button'))) return;
             window.location.href = 'orderdetail.html?id=' + encodeURIComponent(r.id);
          });
          mobileContainer.appendChild(card);
      }
    });
  }
  
  // Fetch from MySQL API
  var allOrders = [];
  var currentPage = 1;
  var itemsPerPage = 5;
  var currentStatus = 'all';
  var currentMonth = 'all';
  var currentYear = 'all';
  var currentSearch = '';
  var currentDateStart = '';
  var currentDateEnd = '';

  function applyFilters() {
    var filtered = allOrders.filter(function(r) {
      // Status Filter
      var s = String(r.status || '').toLowerCase();
      var statusMatch = (currentStatus === 'all') || 
                        (currentStatus === 'active' && s === 'active') ||
                        (currentStatus === 'pending' && (s === 'pending' || s === 'draft')) ||
                        (currentStatus === 'completed' && (s === 'completed' || s === 'done'));
      
      // Search Filter
      var searchLower = currentSearch.toLowerCase();
      var searchMatch = !currentSearch || 
                        String(r.id).toLowerCase().includes(searchLower) ||
                        String(r.clientName || '').toLowerCase().includes(searchLower) ||
                        String(r.packageName || '').toLowerCase().includes(searchLower);

      // Date Parsing
      var orderDate = r.startDate ? new Date(r.startDate) : (r.created_at ? new Date(r.created_at) : null);
      
      // Month & Year Filter
      var monthMatch = true;
      var yearMatch = true;
      
      if (orderDate) {
          if (currentMonth !== 'all') {
              // getMonth() is 0-indexed (0=Jan, 11=Dec), our value is 1-12
              monthMatch = (orderDate.getMonth() + 1) == parseInt(currentMonth);
          }
          if (currentYear !== 'all') {
              yearMatch = orderDate.getFullYear() == parseInt(currentYear);
          }
      } else if (currentMonth !== 'all' || currentYear !== 'all') {
          // If filtering by date components but order has no date, exclude it
          monthMatch = false;
          yearMatch = false;
      }

      // Custom Date Range Filter (Overrules Month/Year if set, or works in conjunction? 
      // Let's make it additive: Must match Month/Year AND Range if both present)
      var rangeMatch = true;
      if (orderDate) {
          if (currentDateStart) {
              rangeMatch = rangeMatch && (orderDate >= new Date(currentDateStart));
          }
          if (currentDateEnd) {
              var dEnd = new Date(currentDateEnd);
              dEnd.setHours(23, 59, 59, 999);
              rangeMatch = rangeMatch && (orderDate <= dEnd);
          }
      } else if (currentDateStart || currentDateEnd) {
          rangeMatch = false;
      }
      
      return statusMatch && searchMatch && monthMatch && yearMatch && rangeMatch;
    });

    // Sort Descending by Date (Newest First)
    filtered.sort((a, b) => {
        var dateA = a.created_at ? new Date(a.created_at) : (a.startDate ? new Date(a.startDate) : new Date(0));
        var dateB = b.created_at ? new Date(b.created_at) : (b.startDate ? new Date(b.startDate) : new Date(0));
        return dateB - dateA || b.id - a.id;
    });

    var totalItems = filtered.length;
    var totalPages = Math.ceil(totalItems / itemsPerPage);
    
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    
    var start = (currentPage - 1) * itemsPerPage;
    var end = start + itemsPerPage;
    var paginatedItems = filtered.slice(start, end);

    renderOrders(paginatedItems);
    renderPagination(totalItems, Math.min(start + 1, totalItems), Math.min(end, totalItems), totalPages);
  }

  function renderPagination(totalItems, start, end, totalPages) {
      var infoEl = document.getElementById('pagination-info');
      if (infoEl) {
          infoEl.innerHTML = `Menampilkan <span class="text-slate-900 dark:text-white font-medium">${totalItems > 0 ? start : 0} - ${end}</span> dari <span class="text-slate-900 dark:text-white font-medium">${totalItems}</span> pesanan`;
      }

      var controlsEl = document.getElementById('pagination-controls');
      if (!controlsEl) return;
      controlsEl.innerHTML = '';

      if (totalPages <= 1) return;

      // Prev Button
      var prevBtn = document.createElement('button');
      prevBtn.className = "size-8 rounded-lg bg-slate-200 dark:bg-white/5 border border-slate-300 dark:border-white/10 flex items-center justify-center text-slate-500 dark:text-secondary/80 hover:text-slate-900 dark:hover:text-white disabled:opacity-30 transition-colors";
      prevBtn.disabled = currentPage === 1;
      prevBtn.innerHTML = '<span class="material-symbols-outlined text-lg">chevron_left</span>';
      prevBtn.onclick = function() {
          if (currentPage > 1) {
              currentPage--;
              applyFilters();
          }
      };
      controlsEl.appendChild(prevBtn);

      // Page Numbers
      var startPage = Math.max(1, currentPage - 2);
      var endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) {
          startPage = Math.max(1, endPage - 4);
      }
      
      for (var i = startPage; i <= endPage; i++) {
          if (i < 1) continue;
          var btn = document.createElement('button');
          if (i === currentPage) {
              btn.className = "size-8 rounded-lg bg-primary text-white text-xs font-bold shadow-lg shadow-primary/25";
          } else {
              btn.className = "size-8 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-500 dark:text-secondary/80 hover:bg-slate-200 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-white text-xs font-bold transition-colors";
          }
          btn.textContent = i;
          btn.onclick = (function(page) {
              return function() {
                  currentPage = page;
                  applyFilters();
              };
          })(i);
          controlsEl.appendChild(btn);
      }

      // Next Button
      var nextBtn = document.createElement('button');
      nextBtn.className = "size-8 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 flex items-center justify-center text-slate-500 dark:text-secondary/80 hover:bg-slate-200 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-white transition-colors";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.innerHTML = '<span class="material-symbols-outlined text-lg">chevron_right</span>';
      nextBtn.onclick = function() {
          if (currentPage < totalPages) {
              currentPage++;
              applyFilters();
          }
      };
      controlsEl.appendChild(nextBtn);
  }

  // Setup Status Dropdown Listener
  var statusSelect = document.getElementById('status-filter');
  if (statusSelect) {
      statusSelect.addEventListener('change', function(e) {
          currentStatus = e.target.value;
          currentPage = 1;
          applyFilters();
      });
  }

  // Setup Month & Year Listeners
  var monthSelect = document.getElementById('month-filter');
  var yearSelect = document.getElementById('year-filter');
  if (monthSelect) {
      monthSelect.addEventListener('change', function(e) {
          currentMonth = e.target.value;
          currentPage = 1;
          applyFilters();
      });
  }
  if (yearSelect) {
      yearSelect.addEventListener('change', function(e) {
          currentYear = e.target.value;
          currentPage = 1;
          applyFilters();
      });
  }

  // Setup Search Listener
  var searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      currentSearch = e.target.value;
      currentPage = 1;
      applyFilters();
    });
  }

  // Setup Date Listeners
  var dateStartInput = document.getElementById('date-start');
  var dateEndInput = document.getElementById('date-end');
  if (dateStartInput) {
      dateStartInput.addEventListener('change', function(e) {
          currentDateStart = e.target.value;
          currentPage = 1;
          applyFilters();
      });
  }
  if (dateEndInput) {
      dateEndInput.addEventListener('change', function(e) {
          currentDateEnd = e.target.value;
          currentPage = 1;
          applyFilters();
      });
  }

  fetch('/api/orders')
    .then(function(res){ return res.json(); })
    .then(function(data){
       allOrders = Array.isArray(data) ? data : [];
       applyFilters();
    })
    .catch(function(err){
       console.error("Error loading orders:", err);
       var tbody = document.getElementById("orders-tbody");
       if(tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-400">Gagal memuat data: ' + err.message + '</td></tr>';
    });

  // Client Search Logic
  var clientSearchInput = document.getElementById('client-search');
  var clientResults = document.getElementById('client-results');
  var clientForm = {
      id: document.getElementById('client-id'),
      name: document.getElementById('client-name'),
      business: document.getElementById('client-business'),
      wa: document.getElementById('client-wa'),
      address: document.getElementById('client-address')
  };
  
  var searchTimeout = null;

  if (clientSearchInput) {
      clientSearchInput.addEventListener('input', function(e) {
          var q = e.target.value;
          clearTimeout(searchTimeout);
          
          if (q.length < 2) {
              clientResults.classList.add('hidden');
              return;
          }

          searchTimeout = setTimeout(function() {
              fetch('/api/clients?q=' + encodeURIComponent(q))
                  .then(res => res.json())
                  .then(data => {
                      clientResults.innerHTML = '';
                      if (data.length > 0) {
                          clientResults.classList.remove('hidden');
                          data.forEach(client => {
                              var div = document.createElement('div');
                              div.className = 'p-3 hover:bg-slate-50 dark:hover:bg-white/5 cursor-pointer transition-colors';
                              div.innerHTML = `
                                  <div class="font-bold text-sm text-slate-900 dark:text-white">${client.name}</div>
                                  <div class="text-xs text-slate-500 dark:text-slate-400">${client.business_name || '-'}  ${client.whatsapp || '-'}</div>
                              `;
                              div.addEventListener('click', function() {
                                  selectClient(client);
                              });
                              clientResults.appendChild(div);
                          });
                      } else {
                          clientResults.classList.add('hidden');
                      }
                  })
                  .catch(err => console.error(err));
          }, 300);
      });
      
      // Close results when clicking outside
      document.addEventListener('click', function(e) {
          if (!clientSearchInput.contains(e.target) && !clientResults.contains(e.target)) {
              clientResults.classList.add('hidden');
          }
      });
  }

  function selectClient(client) {
      clientForm.id.value = client.id;
      clientForm.name.value = client.name;
      clientForm.business.value = client.business_name || '';
      clientForm.wa.value = client.whatsapp || '';
      clientForm.address.value = client.address || '';
      clientResults.classList.add('hidden');
      clientSearchInput.value = '';
      
      // Auto advance visual cue
      document.getElementById('step-2').classList.remove('opacity-50', 'pointer-events-none');
      document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  document.getElementById('btn-new-client').addEventListener('click', function() {
      clientForm.id.value = '';
      clientForm.name.value = '';
      clientForm.business.value = '';
      clientForm.wa.value = '';
      clientForm.address.value = '';
      document.getElementById('client-name').focus();
      
      document.getElementById('step-2').classList.remove('opacity-50', 'pointer-events-none');
  });

  // Service Type & Dynamic Fields
  var serviceTypeRadios = document.getElementsByName('service_type');
  var dynamicFieldsContainer = document.getElementById('dynamic-fields');

  window.calculateAdsEndDate = function() {
      var startInput = document.querySelector('input[name="ads_start_date"]');
      var durationInput = document.querySelector('input[name="ads_duration"]');
      var endInput = document.querySelector('input[name="ads_end_date"]');
      
      if (startInput && durationInput && endInput && startInput.value && durationInput.value) {
          var startDate = new Date(startInput.value);
          var duration = parseInt(durationInput.value);
          if (!isNaN(startDate.getTime()) && !isNaN(duration)) {
              var endDate = new Date(startDate);
              endDate.setDate(startDate.getDate() + duration);
              endInput.value = endDate.toISOString().split('T')[0];
          }
      }
  };

  function renderDynamicFields(type) {
      var html = '';
      switch(type) {
          case 'ads':
              html = `
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Platform</label>
                          <select name="ads_platform" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                              <option value="meta">Meta Ads (FB/IG)</option>
                              <option value="google">Google Ads</option>
                              <option value="tiktok">TikTok Ads</option>
                              <option value="shopee">Shopee Ads</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Objective</label>
                          <select name="ads_objective" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                              <option value="awareness">Awareness</option>
                              <option value="traffic">Traffic</option>
                              <option value="leads">Leads</option>
                              <option value="sales">Sales</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Daily Budget</label>
                          <input type="number" name="ads_budget" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="Ex: 50000">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Durasi (Hari)</label>
                          <input type="number" name="ads_duration" onchange="calculateAdsEndDate()" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" value="30">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Start Date</label>
                          <input type="date" name="ads_start_date" onchange="calculateAdsEndDate()" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">End Date</label>
                          <input type="date" name="ads_end_date" readonly class="w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-500 cursor-not-allowed">
                      </div>
                      <div class="md:col-span-2">
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Target Audience</label>
                          <textarea name="ads_audience" rows="2" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="Lokasi, Umur, Minat..."></textarea>
                      </div>
                  </div>
              `;
              break;
          case 'creative':
              html = `
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Category</label>
                          <select name="creative_type" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                              <option value="sosmed">Sosmed Management</option>
                              <option value="logo">Logo / Branding</option>
                              <option value="video">Video Editing</option>
                              <option value="animation">Animation</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Quantity</label>
                          <input type="number" name="creative_qty" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" value="1">
                      </div>
                      <div class="md:col-span-2">
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Theme / Style Request</label>
                          <textarea name="creative_style" rows="2" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="Minimalist, Colorful, Corporate..."></textarea>
                      </div>
                      <div class="md:col-span-2">
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Reference Link</label>
                          <input type="url" name="creative_ref" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="https://...">
                      </div>
                  </div>
              `;
              break;
          case 'development':
              html = `
                  <div class="grid grid-cols-1 gap-4">
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Project Type</label>
                          <select name="dev_type" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                              <option value="landing">Landing Page</option>
                              <option value="company_profile">Company Profile</option>
                              <option value="webapp">Web Application</option>
                              <option value="mobileapp">Mobile App</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Key Features / Requirements</label>
                          <textarea name="dev_features" rows="4" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="Describe the main features..."></textarea>
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Target Deadline</label>
                          <input type="date" name="dev_deadline" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                      </div>
                  </div>
              `;
              break;
          case 'training':
              html = `
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="md:col-span-2">
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Training Topic</label>
                          <input type="text" name="training_topic" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" placeholder="Ex: Digital Marketing 101">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Participants</label>
                          <input type="number" name="training_pax" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary" value="1">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Date</label>
                          <input type="date" name="training_date" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                      </div>
                   </div>
              `;
              break;
          case 'prodigi':
              html = `
                  <div class="grid grid-cols-1 gap-4">
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Product Name</label>
                          <input type="text" name="prodigi_name" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                      </div>
                      <div>
                          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">License Type</label>
                          <select name="prodigi_license" class="w-full bg-white dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary">
                              <option value="personal">Personal Use</option>
                              <option value="commercial">Commercial Use</option>
                              <option value="extended">Extended License</option>
                          </select>
                      </div>
                  </div>
              `;
              break;
      }
      dynamicFieldsContainer.innerHTML = html;
      
      // Unlock Step 3
      document.getElementById('step-3').classList.remove('opacity-50', 'pointer-events-none');
  }

  // Fetch Packages
  var allPackages = [];
  fetch('/api/packages')
      .then(res => res.json())
      .then(data => {
          allPackages = data;
          var currentType = document.querySelector('input[name="service_type"]:checked').value;
          updatePackageOptions(currentType);
      })
      .catch(err => console.error("Error loading packages:", err));

  function updatePackageOptions(category) {
      var select = document.getElementById('package-select');
      if (!select) return;
      
      select.innerHTML = '<option value="">Pilih Paket...</option>';
      var filtered = allPackages.filter(p => p.category === category && p.active);
      
      filtered.forEach(p => {
          var opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          opt.dataset.price = p.price;
          opt.dataset.duration = p.duration;
          opt.dataset.desc = p.description;
          select.appendChild(opt);
      });
  }

  // Update renderDynamicFields to also update packages and toggle brief section
  var originalRender = renderDynamicFields;
  renderDynamicFields = function(type) {
      originalRender(type);
      updatePackageOptions(type);
      
      var commonBrief = document.getElementById('common-brief-section');
      if (commonBrief) {
          if (type === 'ads') {
              commonBrief.classList.remove('hidden');
          } else {
              commonBrief.classList.add('hidden');
          }
      }
  };

  // Package Info Display
  document.getElementById('package-select').addEventListener('change', function(e) {
      var opt = e.target.selectedOptions[0];
      var infoDiv = document.getElementById('package-info');
      
      if (opt && opt.value) {
          infoDiv.classList.remove('hidden');
          document.getElementById('pkg-price').textContent = 'Rp ' + Number(opt.dataset.price).toLocaleString('id-ID');
          document.getElementById('pkg-duration').textContent = opt.dataset.duration + ' Hari';
          document.getElementById('pkg-desc').textContent = opt.dataset.desc || '-';
      } else {
          infoDiv.classList.add('hidden');
      }
  });

  // Save Order Logic
  document.getElementById('btn-save-order').addEventListener('click', function() {
      var btn = this;
      btn.disabled = true;
      btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span> Menyimpan...';

      // 1. Client Data
      var clientData = {
          id: clientForm.id.value || null,
          name: clientForm.name.value,
          businessName: clientForm.business.value,
          whatsapp: clientForm.wa.value,
          address: clientForm.address.value
      };

      if (!clientData.name) {
          alert('Nama Klien wajib diisi');
          btn.disabled = false;
          btn.innerHTML = '<span class="material-symbols-outlined text-sm">save</span> Simpan Pesanan';
          return;
      }

      // 2. Order Data
      var serviceType = document.querySelector('input[name="service_type"]:checked').value;
      
      // Logic Status Order (Baru vs Perpanjang) untuk Ads
      var orderStatus = 'pending';
      var isRepeatOrder = false;
      
      if (serviceType === 'ads') {
          var inputWa = (clientForm.wa.value || '').trim().replace(/[^0-9]/g, '');
          var inputBusiness = (clientForm.business.value || '').trim().toLowerCase();
          
          if (inputWa) {
             // Cek apakah No HP sudah ada di sistem (di allOrders)
             var phoneExists = allOrders.some(function(o) {
                 var oWa = (o.clientWhatsapp || '').trim().replace(/[^0-9]/g, '');
                 return oWa && oWa === inputWa;
             });
             
             if (!phoneExists) {
                 // No HP belum ada -> BARU
                 orderStatus = 'baru';
                 isRepeatOrder = false;
             } else {
                 // No HP ada. Cek apakah ada yang Nama Usahanya sama persis?
                 var businessMatch = allOrders.some(function(o) {
                     var oWa = (o.clientWhatsapp || '').trim().replace(/[^0-9]/g, '');
                     var oBus = (o.businessName || '').trim().toLowerCase();
                     return oWa === inputWa && oBus === inputBusiness;
                 });
                 
                 if (businessMatch) {
                     // No HP sama DAN Nama Usaha sama -> PERPANJANG
                     orderStatus = 'perpanjang';
                     isRepeatOrder = true;
                 } else {
                     // No HP sama TAPI Nama Usaha beda -> BARU
                     orderStatus = 'baru';
                     isRepeatOrder = false;
                 }
             }
          }
      }

      var packageId = document.getElementById('package-select').value;
      
      if (!packageId) {
          alert('Silakan pilih paket terlebih dahulu');
          btn.disabled = false;
          btn.innerHTML = '<span class="material-symbols-outlined text-sm">save</span> Simpan Pesanan';
          return;
      }

      // 3. Meta Data (Dynamic Fields)
      var metaData = {};
      var inputs = dynamicFieldsContainer.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
          if (input.name) {
              metaData[input.name] = input.value;
          }
      });

      // 4. General Details
      var details = {
          description: document.getElementById('brief-desc').value,
          advantages: document.getElementById('brief-adv').value,
          uniqueness: document.getElementById('brief-unique').value,
          promo: document.getElementById('brief-promo').value
      };

      // 5. Targets
      var targets = {
          locations: document.getElementById('target-loc').value,
          ageRange: document.getElementById('target-age').value,
          gender: document.getElementById('target-gender').value
      };

      // Construct Payload
      const userId = localStorage.getItem('user_id');
      const userRole = localStorage.getItem('role');
      
      var payload = {
          client: clientData,
          clientId: clientData.id,
          userId: userId,
          userRole: (userRole || '').toLowerCase(),
          order: {
              serviceType: serviceType,
              packageId: packageId,
              metaData: metaData,
              status: orderStatus,
              repeatOrder: isRepeatOrder,
              csId: document.getElementById('assignment-cs') ? document.getElementById('assignment-cs').value : null
          },
          details: details,
          targets: targets
      };

      // Send to API
      fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
          if (data.error) throw new Error(data.error);
          
          alert('Pesanan berhasil dibuat! ID: ' + data.orderId);
          closeOrderModal();
          
          // Refresh Table
          window.location.reload(); 
      })
      .catch(err => {
          console.error(err);
          alert('Gagal menyimpan pesanan: ' + err.message);
          btn.disabled = false;
          btn.innerHTML = '<span class="material-symbols-outlined text-sm">save</span> Simpan Pesanan';
      });
  });

  // Initial render
  renderDynamicFields('ads');

  Array.from(serviceTypeRadios).forEach(radio => {
      radio.addEventListener('change', function(e) {
          renderDynamicFields(e.target.value);
      });
  });

  // Smart Order Logic
  function parseSmartOrderText(src) {
    var text = (src || "").replace(/\r\n/g, "\n").trim();
    var lines = text.split("\n").map(function(l){return l.trim();});
    var result = {
      tanggal:"", nama:"", usaha:"", jenisUsaha:"", wa:"", alamat:"", durasi:"",
      deskripsi:"", keunggulan:"", keunikan:"", promo:"",
      lokasi:"", usia:"", gender:"",
      total:"", cs:"", status:""
    };
    function isKeyLine(l){
      return /^Tanggal:|^Nama:|^Nama Usaha:|^Jenis Usaha:|^No Whatsapp Bisnis:|^Alamat:|^Durasi:|^Deskripsi produk\/jasa:|^\*?Keunggulan usaha|^\*?keunikan usaha|^Promo:|^Lokasi:|^Usia:|^Jenis kelamin:|^Total Bayar:|^Cs:|^Status:/i.test(l);
    }
    var i=0, n=lines.length;
    function captureMultiline(startIdx){
      var buf=[], j=startIdx;
      for(; j<n; j++){
        var ln=lines[j];
        if (ln==="----" || /^Data Pemesan|^Data Target Iklan|^Data Pembayaran$/i.test(ln) || (isKeyLine(ln) && j!==startIdx)) break;
        if (ln.length>0) buf.push(ln);
      }
      return {value: buf.join(" ").replace(/\s+/g," ").trim(), next:j};
    }
    while(i<n){
      var line=lines[i];
      if (/^Tanggal:/i.test(line)){ result.tanggal=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Nama:/i.test(line)){ result.nama=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Nama Usaha:/i.test(line)){ result.usaha=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Jenis Usaha:/i.test(line)){ result.jenisUsaha=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^No Whatsapp Bisnis:/i.test(line)){ result.wa=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Alamat:/i.test(line)){ 
        var rest=line.replace(/^Alamat:/i,"").trim();
        if (rest){ result.alamat=rest; i++; continue; }
        var cap=captureMultiline(i+1); result.alamat=cap.value; i=cap.next; continue;
      }
      if (/^Durasi:/i.test(line)){ result.durasi=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Deskripsi produk\/jasa:/i.test(line)){
        var cap2=captureMultiline(i+1); result.deskripsi=cap2.value; i=cap2.next; continue;
      }
      if (/^\*?Keunggulan usaha/i.test(line)){
        result.keunggulan=line.split(":").slice(1).join(":").trim(); i++; continue;
      }
      if (/^\*?keunikan usaha/i.test(line)){
        result.keunikan=line.split(":").slice(1).join(":").trim(); i++; continue;
      }
      if (/^Promo:/i.test(line)){ result.promo=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Lokasi:/i.test(line)){ result.lokasi=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Usia:/i.test(line)){ result.usia=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Jenis kelamin:/i.test(line)){ result.gender=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Total Bayar:/i.test(line)){ result.total=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Cs:/i.test(line)){ result.cs=line.split(":").slice(1).join(":").trim(); i++; continue; }
      if (/^Status:/i.test(line)){ result.status=line.split(":").slice(1).join(":").trim(); i++; continue; }
      i++;
    }
    return result;
  }

  // Smart Order UI Events
  var toggleSmart = document.getElementById('toggle-smart-order');
  var panelSmart = document.getElementById('smart-order-panel');
  var btnSmartParse = document.getElementById('btn-smart-parse');
  var srcSmart = document.getElementById('smart-src-text');
  var serviceSmart = document.getElementById('smart-service-type');

  if(toggleSmart && panelSmart) {
    toggleSmart.addEventListener('change', function() {
        if(this.checked) {
            panelSmart.classList.remove('hidden');
        } else {
            panelSmart.classList.add('hidden');
        }
    });
  }

  if(btnSmartParse && srcSmart && serviceSmart) {
      btnSmartParse.addEventListener('click', function() {
          var text = srcSmart.value;
          if(!text) { alert('Mohon tempelkan teks pesanan terlebih dahulu.'); return; }
          
          var r = parseSmartOrderText(text);
          var targetService = serviceSmart.value;

          // 1. Populate Client
          if(r.nama) document.getElementById('client-name').value = r.nama;
          if(r.usaha) document.getElementById('client-business').value = r.usaha + (r.jenisUsaha ? ' (' + r.jenisUsaha + ')' : '');
          if(r.wa) document.getElementById('client-wa').value = r.wa;
          if(r.alamat) document.getElementById('client-address').value = r.alamat;
          
          // Clear client ID to ensure it's treated as new/updated info unless we search (Search is separate)
          // Ideally we might want to search for existing client by WA here? 
          // For now, let's assume it populates the form for "New Client" or manual entry.
          document.getElementById('client-id').value = ''; 

          // 2. Set Service Type
          var radio = document.querySelector('input[name="service_type"][value="' + targetService + '"]');
          if(radio) {
              radio.checked = true;
              renderDynamicFields(targetService);
          }

          // 3. Populate Dynamic Fields
          setTimeout(function() { // Delay slightly to ensure DOM is ready
              // Common Fields (Brief & Target)
              if(document.getElementById('brief-desc')) document.getElementById('brief-desc').value = r.deskripsi || '';
              if(document.getElementById('brief-adv')) document.getElementById('brief-adv').value = r.keunggulan || '';
              if(document.getElementById('brief-unique')) document.getElementById('brief-unique').value = r.keunikan || '';
              if(document.getElementById('brief-promo')) document.getElementById('brief-promo').value = r.promo || '';
              
              if(document.getElementById('target-loc')) document.getElementById('target-loc').value = r.lokasi || '';
              if(document.getElementById('target-age')) document.getElementById('target-age').value = r.usia || '';
              
              if(r.gender && document.getElementById('target-gender')) {
                  var g = r.gender.toLowerCase();
                  if(g.includes('laki') || g.includes('pria') || g.includes('male')) document.getElementById('target-gender').value = 'Male';
                  else if(g.includes('perempuan') || g.includes('wanita') || g.includes('female')) document.getElementById('target-gender').value = 'Female';
                  else document.getElementById('target-gender').value = 'All';
              }
              if(targetService === 'ads') {
                  if(r.lokasi || r.usia || r.gender) {
                      var audience = [];
                      if(r.lokasi) audience.push('Lokasi: ' + r.lokasi);
                      if(r.usia) audience.push('Usia: ' + r.usia);
                      if(r.gender) audience.push('Gender: ' + r.gender);
                      var audEl = document.querySelector('textarea[name="ads_audience"]');
                      if(audEl) audEl.value = audience.join('\n');
                  }
                  if(r.total) {
                      var budget = r.total.replace(/[^0-9]/g, '');
                      var budEl = document.querySelector('input[name="ads_budget"]');
                      if(budEl) budEl.value = budget;
                  }
                  if(r.durasi) {
                      var dur = r.durasi.replace(/[^0-9]/g, '');
                      var durEl = document.querySelector('input[name="ads_duration"]');
                      if(durEl && dur) durEl.value = dur;
                  }
              }



              // 4. Unlock Steps
              document.getElementById('step-2').classList.remove('opacity-50', 'pointer-events-none');
              document.getElementById('step-3').classList.remove('opacity-50', 'pointer-events-none');
              
              // 5. UX Feedback
              toggleSmart.checked = false;
              panelSmart.classList.add('hidden');
              
              // Scroll to client form to verify
              document.getElementById('client-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
              
              // Optional: Highlight updated fields?
          }, 100);
      });
  }

  // CS Loading Logic
  function loadCSList() {
      const select = document.getElementById('assignment-cs');
      if (!select || select.dataset.loaded) return;
      
      fetch('/api/users?role=cs')
          .then(res => res.json())
          .then(data => {
              select.innerHTML = '<option value="">Pilih CS...</option>';
              data.forEach(user => {
                  const opt = document.createElement('option');
                  opt.value = user.id;
                  opt.textContent = user.name;
                  select.appendChild(opt);
              });
              select.dataset.loaded = 'true';
          })
          .catch(err => console.error('Error loading CS:', err));
  }

  // Modal Control
  window.openOrderModal = function() {
      document.getElementById('new-order-modal').classList.remove('hidden');
      document.body.classList.add('overflow-hidden');

      const role = (localStorage.getItem('role') || '').toLowerCase();
      const csSection = document.getElementById('step-assignment');
      if (role === 'super_admin' && csSection) {
          csSection.classList.remove('hidden');
          loadCSList();
      } else if (csSection) {
          csSection.classList.add('hidden');
      }
  };
  
  window.closeOrderModal = function() {
      document.getElementById('new-order-modal').classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
  };

  if (openBtn) {
    openBtn.addEventListener("click", function (e) {
      e.preventDefault();
      openOrderModal();
    });
  }
  // Role Access Control for New Order Button
  const userRole = (localStorage.getItem('role') || 'super_admin').toLowerCase();
  const btnInputBaru = document.getElementById('btn-input-baru');
  if (btnInputBaru) {
      // Ensure we clear any inline display:none if allowed
      if (userRole === 'cs' || userRole === 'super_admin') {
          btnInputBaru.style.display = 'inline-flex';
          btnInputBaru.classList.remove('hidden');
      } else {
          btnInputBaru.style.display = 'none';
      }
  }

  // Handle action=new from dashboard
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('action') === 'new') {
      // Delay slightly to ensure modal logic is ready
      setTimeout(() => {
          if (typeof window.openOrderModal === 'function') {
              window.openOrderModal();
          }
      }, 100);
  }

});
</script>
</body></html>
