<!DOCTYPE html>

<html class="dark" lang="en"><head>
<script>(function(){try{var t=localStorage.getItem("theme");if(t==="light"){document.documentElement.classList.remove("dark");}else{document.documentElement.classList.add("dark");}}catch(e){document.documentElement.classList.add("dark");}})();</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Nyala Digital Apps - Finance Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#ef7225",
        secondary: "#0d3b66",
        "background-light": "#f5f7f8",
        "background-dark": "#0b0e14",
        "sidebar-dark": "#101922"
      },
      fontFamily: { display: ["Inter", "sans-serif"] },
      borderRadius: { DEFAULT: "0.5rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" }
    }
  }
};
</script>
<style>
body { font-family: 'Inter', sans-serif; }
.glass-surface {
  background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.14), transparent 60%),
              radial-gradient(circle at bottom right, rgba(29, 155, 240, 0.18), transparent 60%);
}
.glass-panel {
  background: rgba(6, 12, 31, 0.94);
  border: 1px solid rgba(148, 163, 184, 0.35);
  backdrop-filter: blur(22px);
  -webkit-backdrop-filter: blur(22px);
}
.glass-card {
  background: rgba(255, 255, 255, 0.04);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
</style>
</head>
<body class="bg-background-light text-slate-900 dark:bg-background-dark dark:text-white min-h-screen glass-surface" data-active="finance">
<div class="hidden dark:block fixed inset-0 pointer-events-none opacity-30">
  <div class="absolute inset-0 bg-[radial-gradient(#0f172a_1px,transparent_1px)] [background-size:40px_40px]"></div>
</div>
<div class="relative z-10 min-h-screen flex flex-col">
  <div id="include-header"></div>
  <div class="flex-1 max-w-7xl mx-auto w-full px-6 py-6 flex gap-5">
    <div id="include-sidebar"></div>
    <main class="flex-1 flex flex-col min-w-0">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Keuangan &amp; Billing</h2>
          <p class="text-secondary/80 text-sm mt-1">Ringkasan arus kas, spend, dan payroll.</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="hidden md:flex items-center bg-white/5 border border-white/10 rounded-full px-3 py-1.5 w-64">
            <span class="material-symbols-outlined text-[#90aecb] text-lg">search</span>
            <input type="text" placeholder="Search report..." class="bg-transparent border-none focus:ring-0 text-sm text-white placeholder-[#90aecb] w-full">
          </div>
          <button class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-[11px] font-medium text-white bg-primary hover:bg-primary/90 border border-white/10 transition-colors">
            <span class="material-symbols-outlined text-sm">download</span>
            <span>Export PDF</span>
          </button>
        </div>
      </div>
      <div class="space-y-8">
<!-- KPI Section -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
<div class="glass-card p-6 rounded-xl flex flex-col gap-2">
<div class="flex justify-between items-start">
<span class="text-slate-400 text-sm font-medium">Pemasukan</span>
<div class="p-2 rounded-lg">
<span class="material-symbols-outlined text-[#ef7225]">trending_up</span>
</div>
</div>
<h3 id="kpi-revenue" class="text-2xl font-bold text-white">Rp 0</h3>
<p class="text-emerald-400 text-xs font-medium flex items-center gap-1">
<span class="material-symbols-outlined text-[14px]">arrow_upward</span> +0% vs last month
                        </p>
</div>
<div class="glass-card p-6 rounded-xl flex flex-col gap-2">
<div class="flex justify-between items-start">
<span class="text-slate-400 text-sm font-medium">Ad Spend</span>
<div class="p-2 rounded-lg bg-orange-500/10 text-orange-500">
<span class="material-symbols-outlined">ad_units</span>
</div>
</div>
<h3 id="kpi-ad-spend" class="text-2xl font-bold text-white">Rp 0</h3>
<p class="text-slate-400 text-xs font-medium">Meta Ads &amp; Google Ads</p>
</div>
<div class="glass-card p-6 rounded-xl flex flex-col gap-2">
<div class="flex justify-between items-start">
<span class="text-slate-400 text-sm font-medium">Operasional</span>
<div class="p-2 rounded-lg bg-indigo-500/10 text-indigo-500">
<span class="material-symbols-outlined">receipt_long</span>
</div>
</div>
<h3 id="kpi-operational" class="text-2xl font-bold text-white">Rp 0</h3>
<p class="text-slate-400 text-xs font-medium">SaaS &amp; Infrastructure</p>
</div>
<div class="glass-card p-6 rounded-xl flex flex-col gap-2 relative overflow-hidden group">
<div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
<div class="flex justify-between items-start">
<span class="text-slate-400 text-sm font-medium">Laba Bersih</span>
<div class="bg-emerald-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">
                                +0%
                            </div>
</div>
<h3 id="kpi-net-profit" class="text-2xl font-bold text-emerald-400">Rp 0</h3>
<p class="text-slate-400 text-xs font-medium">Profit margin: 0%</p>
</div>
</div>
<!-- Analytics Chart Removed -->
      <!-- Detailed Breakdown -->
<div class="space-y-4">
    <!-- Controls -->
    <div class="flex flex-col md:flex-row gap-4 justify-between items-end">
        <div class="flex-1 w-full md:w-auto">
             <label class="block text-xs font-medium text-slate-400 mb-1">Search Order</label>
             <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-2.5 text-slate-500 text-sm">search</span>
                <input type="text" id="finance-search" onkeyup="applyFilters()" placeholder="Client name, package..." class="pl-9 bg-white/5 border border-white/10 rounded-lg text-sm text-white px-3 py-2 focus:ring-primary focus:border-primary w-full md:w-64">
             </div>
        </div>
        <div class="flex gap-2 items-end w-full md:w-auto">
             <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">From</label>
                <input type="date" id="finance-start-date" class="bg-white/5 border border-white/10 rounded-lg text-sm text-white px-3 py-2 focus:ring-primary focus:border-primary">
             </div>
             <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">To</label>
                <input type="date" id="finance-end-date" class="bg-white/5 border border-white/10 rounded-lg text-sm text-white px-3 py-2 focus:ring-primary focus:border-primary">
             </div>
             <button onclick="applyFilters()" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-white text-sm font-bold rounded-lg transition-colors flex items-center justify-center h-[38px]">
                <span class="material-symbols-outlined text-lg">filter_list</span>
             </button>
        </div>
    </div>

<div class="glass-card rounded-xl overflow-hidden">
<table class="w-full text-left border-collapse">
<thead>
<tr class="border-b border-white/10 bg-white/2">
<th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Order Name</th>
<th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Masuk (Revenue)</th>
<th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Est. Keluar</th>
<th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Real Spend</th>
<th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Profit</th>
<th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Action</th>
</tr>
</thead>
<tbody id="finance-orders-body" class="divide-y divide-white/5">
<tr>
<td colspan="6" class="px-6 py-8 text-center text-slate-500 italic">Memuat data...</td>
</tr>
</tbody>
</table>
<!-- Pagination -->
<div class="px-6 py-4 border-t border-white/5 flex items-center justify-between bg-white/2">
    <span id="finance-pagination-info" class="text-xs text-slate-400 font-medium">Showing 0 of 0 orders</span>
    <div class="flex gap-2">
        <button id="btn-prev" onclick="changePage(-1)" class="px-3 py-1 bg-white/5 rounded border border-white/10 text-xs font-bold text-slate-400 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
        <button id="btn-next" onclick="changePage(1)" class="px-3 py-1 rounded text-xs font-bold text-white bg-primary hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
    </div>
</div>
</div>
      <!-- Summary Row Removed -->

<!-- User Commission Report -->
<div class="glass-card rounded-xl p-6 mt-8">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
        <div>
            <h3 class="text-xl font-bold text-white">Laporan Komisi User</h3>
            <p class="text-slate-400 text-sm">Total komisi per user berdasarkan periode.</p>
        </div>
        <div class="flex flex-wrap items-end gap-3">
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">Mulai Tanggal</label>
                <input type="date" id="comm-start-date" class="bg-white/5 border border-white/10 rounded-lg text-sm text-white px-3 py-2 focus:ring-primary focus:border-primary">
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">Sampai Tanggal</label>
                <input type="date" id="comm-end-date" class="bg-white/5 border border-white/10 rounded-lg text-sm text-white px-3 py-2 focus:ring-primary focus:border-primary">
            </div>
            <button onclick="loadCommissionReport()" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white text-sm font-bold rounded-lg transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">filter_list</span>
                Filter
            </button>
        </div>
    </div>

    <div class="overflow-hidden rounded-xl border border-white/10">
        <table class="w-full text-left border-collapse">
            <thead class="bg-white/5">
                <tr>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Nama User</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Jumlah Pesanan</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Total Komisi</th>
                </tr>
            </thead>
            <tbody id="commission-report-body" class="divide-y divide-white/5">
                <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-slate-500 italic">Silakan pilih rentang tanggal dan klik Filter</td>
                </tr>
            </tbody>
            <tfoot class="bg-white/5 border-t border-white/10 font-bold">
                <tr>
                    <td colspan="2" class="px-6 py-4 text-right text-white">TOTAL</td>
                    <td id="total-orders-sum" class="px-6 py-4 text-center text-white">-</td>
                    <td id="total-commission-sum" class="px-6 py-4 text-right text-primary">-</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
    </main>
  </div>
  <div id="include-footer"></div>
</div>
<script src="js/include.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Set default dates (current month)
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        // Format YYYY-MM-DD for input[type=date]
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const startDateInput = document.getElementById('comm-start-date');
        const endDateInput = document.getElementById('comm-end-date');
        const financeStartDate = document.getElementById('finance-start-date');
        const financeEndDate = document.getElementById('finance-end-date');

        if(startDateInput) startDateInput.value = formatDate(firstDay);
        if(endDateInput) endDateInput.value = formatDate(lastDay);
        if(financeStartDate) financeStartDate.value = formatDate(firstDay);
        if(financeEndDate) financeEndDate.value = formatDate(lastDay);
        
        loadCommissionReport();
        loadFinanceOrders(); // Load main finance table
    });

    async function loadCommissionReport() {
        const startDate = document.getElementById('comm-start-date').value;
        const endDate = document.getElementById('comm-end-date').value;
        const tbody = document.getElementById('commission-report-body');
        
        if(!startDate || !endDate) return;

        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500 italic">Memuat data...</td></tr>';

        try {
            const res = await fetch(`/api/reports/commissions?startDate=${startDate}&endDate=${endDate}`);
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500 italic">Tidak ada data pada periode ini</td></tr>';
                document.getElementById('total-orders-sum').innerText = '0';
                document.getElementById('total-commission-sum').innerText = 'Rp 0';
                return;
            }

            let totalOrders = 0;
            let totalCommission = 0;

            tbody.innerHTML = data.map(item => {
                totalOrders += parseInt(item.order_count);
                totalCommission += parseFloat(item.total_commission);
                return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-primary/20 text-primary flex items-center justify-center text-xs font-bold">
                                ${item.user_name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <p class="text-sm font-bold text-white">${item.user_name}</p>
                                <p class="text-xs text-slate-400">${item.user_email}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${item.user_role === 'super_admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'}">
                            ${item.user_role}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center text-sm text-white font-bold">${item.order_count}</td>
                    <td class="px-6 py-4 text-right text-sm font-bold text-emerald-400">
                        ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(item.total_commission)}
                    </td>
                </tr>
                `;
            }).join('');

            document.getElementById('total-orders-sum').innerText = totalOrders;
            document.getElementById('total-commission-sum').innerText = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(totalCommission);

        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-red-400">Error: ${error.message}</td></tr>`;
        }
    }

    let allFinanceOrders = [];
    let filteredFinanceOrders = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    async function loadFinanceOrders() {
        const tbody = document.getElementById('finance-orders-body');
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500 italic">Memuat data...</td></tr>';
        
        try {
            const res = await fetch('/api/finance/orders');
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);

            allFinanceOrders = data;
            applyFilters(); // Initial render and calculation

        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-red-400">Error: ${error.message}</td></tr>`;
        }
    }

    function applyFilters() {
        const searchInput = document.getElementById('finance-search').value.toLowerCase();
        const startDate = document.getElementById('finance-start-date').value;
        const endDate = document.getElementById('finance-end-date').value;

        filteredFinanceOrders = allFinanceOrders.filter(order => {
            // Search Filter
            const matchesSearch = (order.client_name && order.client_name.toLowerCase().includes(searchInput)) || 
                                  (order.package_name && order.package_name.toLowerCase().includes(searchInput));
            
            // Date Filter
            let matchesDate = true;
            if (startDate && endDate) {
                const orderDate = new Date(order.created_at);
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                matchesDate = orderDate >= start && orderDate <= end;
            }

            return matchesSearch && matchesDate;
        });

        calculateKPIs(filteredFinanceOrders);
        currentPage = 1;
        renderFinanceTable();
    }

    function calculateKPIs(orders) {
        let totalRevenue = 0;
        let totalAdSpend = 0;
        let totalCommission = 0;

        orders.forEach(order => {
            const revenue = parseFloat(order.package_price) || 0;
            const adSpend = parseFloat(order.total_spend) || 0;
            const commission = parseFloat(order.total_commission) || 0;
            
            totalRevenue += revenue;
            totalAdSpend += adSpend;
            totalCommission += commission;
        });

        updateKPIs(totalRevenue, totalAdSpend, totalCommission);
    }

    function renderFinanceTable() {
        const tbody = document.getElementById('finance-orders-body');
        
        if (filteredFinanceOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500 italic">Tidak ada data yang cocok</td></tr>';
            updatePaginationUI();
            return;
        }

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedOrders = filteredFinanceOrders.slice(start, end);

        tbody.innerHTML = paginatedOrders.map(order => {
            const revenue = parseFloat(order.package_price) || 0;
            const adSpend = parseFloat(order.total_spend) || 0;
            const commission = parseFloat(order.total_commission) || 0;
            const profit = revenue - adSpend - commission;

            const clientInitial = order.client_name ? order.client_name.charAt(0).toUpperCase() : '?';
            const createdDate = new Date(order.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });

            const profitPercent = revenue > 0 ? (profit / revenue) * 100 : 0;
            const barWidth = Math.max(0, Math.min(100, profitPercent));
            const barColor = profit >= 0 ? 'bg-emerald-500' : 'bg-red-500';
            const textColor = profit >= 0 ? 'text-emerald-400' : 'text-red-400';

            return `
            <tr class="hover:bg-white/5 transition-colors group">
                <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center text-xs font-bold">${clientInitial}</div>
                        <div>
                            <p class="text-sm font-bold text-white group-hover:text-primary transition-colors">${order.client_name || 'Unknown'}</p>
                            <p class="text-xs text-slate-400">${order.package_name || 'Custom'}</p>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <p class="text-sm font-medium text-white">${formatRupiah(revenue)}</p>
                    <p class="text-xs text-slate-500">${createdDate}</p>
                </td>
                <td class="px-6 py-4">
                    <p class="text-sm font-medium text-slate-300">${formatRupiah(commission)}</p>
                    <p class="text-xs text-slate-500">Commission</p>
                </td>
                <td class="px-6 py-4">
                    <p class="text-sm font-medium text-slate-300">${formatRupiah(adSpend)}</p>
                    <p class="text-xs text-slate-500">Meta/Google Ads</p>
                </td>
                <td class="px-6 py-4">
                    <p class="text-sm font-bold ${textColor}">${formatRupiah(profit)}</p>
                    <div class="w-16 h-1 bg-white/10 rounded-full mt-1 overflow-hidden">
                        <div class="h-full ${barColor}" style="width: ${barWidth}%"></div>
                    </div>
                </td>
                <td class="px-6 py-4 text-right">
                    <button class="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[18px]">more_vert</span>
                    </button>
                </td>
            </tr>
            `;
        }).join('');

        updatePaginationUI();
    }

    function updatePaginationUI() {
        const totalPages = Math.ceil(filteredFinanceOrders.length / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, filteredFinanceOrders.length);
        
        const infoText = filteredFinanceOrders.length > 0 
            ? `Showing ${start} to ${end} of ${filteredFinanceOrders.length} orders`
            : 'Showing 0 of 0 orders';
            
        document.getElementById('finance-pagination-info').innerText = infoText;
        
        document.getElementById('btn-prev').disabled = currentPage === 1;
        document.getElementById('btn-next').disabled = currentPage === totalPages || totalPages === 0;
    }

    function changePage(direction) {
        const totalPages = Math.ceil(filteredFinanceOrders.length / itemsPerPage);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderFinanceTable();
        }
    }

    function updateKPIs(revenue, adSpend, commission) {
        const profit = revenue - adSpend - commission;
        const profitMargin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;

        document.getElementById('kpi-revenue').innerText = formatRupiah(revenue);
        document.getElementById('kpi-ad-spend').innerText = formatRupiah(adSpend);
        document.getElementById('kpi-operational').innerText = formatRupiah(commission);
        document.getElementById('kpi-net-profit').innerText = formatRupiah(profit);
        
        // Update profit margin text if exists, but for now just the values
    }

    function formatRupiah(amount) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    }
</script>
</body></html>
